<!DOCTYPE html>
<html lang="en" style=" height: 100%;">
<head>
    <meta charset="UTF-8">
    <title>Score Board - Sogeti</title>
    <script type="text/javascript" src="js/socket.io.min.js"></script>
    <script type="text/javascript" src="js/bundle.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="css/style.css" rel="stylesheet" media="screen">

    <link href="jquery-ui/jquery-ui.css" rel="stylesheet" media="screen">
    <!-- TODO: choper en local! -->
    <link href="https://fonts.googleapis.com/css?family=Covered+By+Your+Grace|Faster+One|Kaushan+Script" rel="stylesheet">

</head>
<body  style="min-height:100%;">
<div class="section-2"><img class="image-2" src="img/logo.png">
</div>
<div class="w-row scoreboard">
    <div class="w-col w-col-4 contentSmile">
        <h3 class="heading">Just Smile</h3>
    </div>
    <div class="w-col w-col-4 contentRace">
        <h3 class="heading">Course au château</h3>
    </div>
    <div class="w-col w-col-4 contentQuestion">
        <h3 class="heading">Questionnaire</h3>
    </div>
</div>


<div class="row faces">
    <div class="col-md-8 row text-center" style="margin: 0 auto; margin-top: 30px;">
        <h1 class="page_title">Vos plus belles têtes</h1>
    </div>
    <div class="col-md-10 row" style="margin: 0 auto;margin-top: 30px;">
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo0" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face0" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo1" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face1" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo2" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face2" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo3" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face3" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo4" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face4" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo5" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face5" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo6" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face6" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
        <div class="col-md-3 text-center pictures">
            <img style="position:absolute;z-index:3;right:10px;bottom:10px" id="emo7" width="50" height="50" src="img/silhouette.png" alt="Generic placeholder image">
            <img class="rounded-circle img-fluid" id="face7" src="img/silhouette.png" alt="Generic placeholder image">
        </div>
    </div>

</div>


</div> <!-- /container -->
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="jquery-ui/jquery-ui.js"></script>
<script type="text/javascript">
    (function ($) {
        var FakePoller = function(options, callback){
            var defaults = {
                frequency: 60,
                limit: 3,
                page: 1,
                game: 0
            };
            this.callback = callback;
            this.config = $.extend(defaults, options);
            this.firstWithData = true;
        }

        FakePoller.prototype.buildData = function(data) {
            var results = [];
            for (var i = 0, len = data.length; i < len; i++) {
                results.push({
                    rank: i+1,
                    name: data[i].firstname + ' ' + data[i].lastname,
                    count: data[i].score
                });
            }
            return results;
        };

        FakePoller.prototype.processData = function() {
            socket.emit("clientRequestRefresh");
            switch (this.config.game) {
                case 1:
                    var datas = this.buildData(this.sortData(window.scoreJ1));
                    break;
                case 2:
                    var datas = this.buildData(this.sortData(window.scoreJ2));
                    break;
                case 3:
                    var datas = this.buildData(this.sortData(window.scoreJ3));
                    break;
                default:
                    var datas = [];
            }

            if(datas.length >= (this.config.limit*this.config.page) && !this.firstWithData){
                this.config.page++;
            }else if(!this.firstWithData){

                this.config.page = 1;
                this.stop();
                var evt = new CustomEvent('scrollEnd');
                window.dispatchEvent(evt);
                return;
            }


            if(datas.length > 0)
                this.firstWithData = false;

            return datas.slice((this.config.page*this.config.limit-this.config.limit), (this.config.page*this.config.limit));
        };

        FakePoller.prototype.sortData = function(data) {
            return data.sort(function(a, b) {
                return b.score - a.score;
            });
        };
        FakePoller.prototype.start = function() {
            var _this = this;
            this.interval = setInterval((function() {
                _this.callback(_this.processData());
            }), this.config.frequency * 1000);
            this.callback(this.processData());
            return this;
        };
        FakePoller.prototype.stop = function() {
            clearInterval(this.interval);
            return this;
        };
        window.FakePoller = FakePoller;

        var Leaderboard = function (elemId, options) {
            var _this = this;
            var defaults = {
                limit:3,
                frequency:15,
                page: 1,
                game: 0
            };
            this.currentItem = 0;
            this.currentCount = 0;
            this.config = $.extend(defaults,options);

            this.$elem = $(elemId);
            if (!this.$elem.length)
                this.$elem = $('<div>').appendTo($('body'));

            this.list = [];
            this.$content = $('<ul class="leaderboard">');
            this.$elem.append(this.$content);

            this.poller = new FakePoller({frequency: this.config.frequency, limit: this.config.limit, page: this.config.page, game: this.config.game}, function (data) {
                if (data) {
                    if(_this.currentCount != data.length){
                        _this.buildElements(_this.$content,data.length);
                    }
                    _this.currentCount = data.length;
                    _this.data = data;
                    if(typeof _this.list[0] !== 'undefined')
                        _this.list[0].$item.addClass('animate');
                }
            });
            this.poller.start();
        };

        Leaderboard.prototype.buildElements = function($ul,elemSize){
            var _this = this;
            $ul.empty();
            this.list = [];

            for (var i = 0; i < elemSize; i++) {
                var item = $('<li class="w-clearfix">')
                    .on("animationend webkitAnimationEnd oAnimationEnd",eventAnimationEnd.bind(this) )
                    .appendTo($ul);
                this.list.push({
                    $item: item,
                    $rank:  $('<span class="rank"></span> ').appendTo(item),
                    $name:  $('<span class="name"></span>').appendTo(item),
                    $count: $('<span class="count"></span>').appendTo(item)
                });
            }

            function eventAnimationEnd (evt){
                this.list[this.currentItem].$rank.text(_this.data[this.currentItem].rank);
                this.list[this.currentItem].$name.text(_this.data[this.currentItem].name);
                this.list[this.currentItem].$count.text(_this.data[this.currentItem].count);
                this.list[this.currentItem].$item.removeClass('animate');
                this.currentItem = this.currentItem >= this.currentCount - 1 ? 0 : this.currentItem + 1;
                if (this.currentItem != 0) {
                    this.list[this.currentItem].$item.addClass('animate');
                }
            }
        };

        Function.prototype.bind = function(){
            var fn = this, args = Array.prototype.slice.call(arguments),
                object = args.shift();
            return function(){
                return fn.apply(object,args.concat(Array.prototype.slice.call(arguments)));
            };
        };

        window.Leaderboard = Leaderboard;

    })(jQuery);

    var smileGameBoard;
    var questionGameBoard;
    var raceGameBoard;
    $(document).ready(function ($) {
      socket.emit("clientRequestRefresh");
      socket.emit("clientRequestShow", {countPictures: 8});
        $('.faces').hide();
        smileGameBoard = new Leaderboard(".contentSmile", {limit:10,frequency:8, page:1, game:1});
        questionGameBoard = new Leaderboard(".contentQuestion", {limit:20,frequency:8, page:1, game:3});
        raceGameBoard = new Leaderboard(".contentRace", {limit:20,frequency:8, page:1, game:2});
    });

    var numberEnd = 0;
    window.addEventListener('scrollEnd', function () {
        numberEnd++;
        if(numberEnd >= 3){
          numberEnd = 0;
          socket.emit("clientRequestShow", {countPictures: 8});
          $('.scoreboard').hide("slide", { direction: "left" }, function() {
            $('.faces').show("slide", { direction: "right" });
          });

          window.setTimeout(function () {
            $('.faces').hide("slide", { direction: "left" }, function() {
                $('.scoreboard').show("slide", { direction: "right" });
            });
            $('.leaderboard').remove()
            smileGameBoard = new Leaderboard(".contentSmile", {limit:10,frequency:8, page:1, game:1});
            questionGameBoard = new Leaderboard(".contentQuestion", {limit:20,frequency:8, page:1, game:3});
            raceGameBoard = new Leaderboard(".contentRace", {limit:20,frequency:8, page:1, game:2});
          }, 8000);
        }
    });


</script>
</body>
</html>
